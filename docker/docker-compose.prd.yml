version: "3.9"

# Production Environment - OPENAI Configuration (Working Baseline)
# Last Working: October 2025 (101 memories stored)
# Restored: November 25, 2025
# Environment: PRD
# Hardware: Mac Studio M1 Max (mastermagoo.taile6d019.ts.net)
# Access: Tailscale HTTPS (mem0-prd.taile6d019.ts.net)
# Database: mem0 (PostgreSQL), neo4j (Neo4j Community 5.13.0 + GDS)
# Storage: /Volumes/SamsungHA/docker-data/mem0/

services:
  postgres:
    image: pgvector/pgvector:pg17
    container_name: mem0_postgres_prd
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-mem0}
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/postgres:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5433}:5432"
    networks:
      - mem0_internal_prd
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mem0_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  neo4j:
    image: neo4j:5.13.0
    container_name: mem0_neo4j_prd
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NEO4J_PLUGINS: '["graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: gds.*
      NEO4J_dbms_security_procedures_allowlist: gds.*
    ports:
      - "127.0.0.1:${NEO4J_HTTP_PORT:-7474}:7474"
      - "127.0.0.1:${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/neo4j:/data
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/neo4j/logs:/logs
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/neo4j/import:/var/lib/neo4j/import
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/neo4j/plugins:/plugins
    networks:
      - mem0_internal_prd
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mem0:
    image: mem0-openai-fixed:local
    container_name: mem0_server_prd
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    command: ["/bin/bash", "/app/start_mem0_openai.sh"]
    environment:
      # Database connection (PostgreSQL with pgvector)
      DATABASE_URL: postgresql://${POSTGRES_USER:-mem0_user}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/${POSTGRES_DB:-mem0}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-mem0}
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_COLLECTION_NAME: memories
      # API Keys (OpenAI for LLM and embeddings)
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      MEM0_API_KEY: ${MEM0_API_KEY:?MEM0_API_KEY is required}
      # Neo4j graph store (Community 5.13.0 with GDS plugin)
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      # Server configuration
      MEM0_BIND_ADDRESS: 0.0.0.0
      MEM0_PORT: 8888
      HISTORY_DB_PATH: /app/data/history.db
      ENVIRONMENT: prd
    volumes:
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/data:/app/data
      - ../scripts/mem0_gds_patch_v2_simple.py:/app/mem0_gds_patch_v2.py:ro
      - ../scripts/start_mem0_openai.sh:/app/start_mem0_openai.sh:ro
    ports:
      - "127.0.0.1:${MEM0_PORT:-8888}:8888"
    networks:
      - mem0_internal_prd
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8888/docs', timeout=3)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  grafana:
    image: grafana/grafana:latest
    container_name: mem0_grafana_prd
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:?GRAFANA_PASSWORD is required}
      GF_SERVER_ROOT_URL: https://${TS_SERVE_GRAFANA_DOMAIN:-grafana-prd}.${TAILNET_NAME:-taile6d019.ts.net}
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "127.0.0.1:${GRAFANA_PORT:-3001}:3000"
    volumes:
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/grafana:/var/lib/grafana
    networks:
      - mem0_internal_prd
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  telegram_bot:
    build:
      context: ./telegram_bot
    container_name: mem0_telegram_bot_prd
    restart: unless-stopped
    depends_on:
      mem0:
        condition: service_healthy
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN is required}
      MEM0_URL: http://mem0:8888
      MEM0_API_KEY: ${MEM0_API_KEY:?MEM0_API_KEY is required}
      DEFAULT_NAMESPACE: personal
      USER_PREFIX: mark_carey
      MAX_RECALL_RESULTS: "5"
    networks:
      - mem0_internal_prd
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus:latest
    container_name: mem0_prometheus_prd
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ${MEM0_DATA_ROOT:-/Volumes/SamsungHA/docker-data/mem0}/prometheus:/prometheus
    ports:
      - "127.0.0.1:9091:9090"
    networks:
      - mem0_internal_prd
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  mem0_internal_prd:
    driver: bridge
    name: mem0_internal_prd
