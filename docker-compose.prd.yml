name: mem0-prd

# Production environment configuration
# Environment: PRD
# Hardware: Mac Studio (mastermagoo.taile6d019.ts.net)
# Access: Tailscale HTTPS (mem0-prd.taile6d019.ts.net)
# Database: mem0_prd
# Storage: /Volumes/NAS/mem0-prd/

services:
  postgres:
    image: pgvector/pgvector:pg17
    container_name: mem0_postgres_prd
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-mem0_prd}
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user_prd}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:?Must set DEPLOYMENT_ENV=prd in .env}
    volumes:
      - mem0_prd_postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    networks:
      - mem0_internal_prd
    labels:
      - "com.mem0-system.compose-file=docker-compose.prd.yml"
      - "com.mem0-system.environment=production"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mem0_user_prd}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mem0:
    image: ${MEM0_IMAGE:-mem0-fixed:local}
    container_name: mem0_server_prd
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    environment:
      # PostgreSQL connection (mem0 uses individual vars, not DATABASE_URL)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_INTERNAL_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-mem0}
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      # Vector collection (avoid mixed-dimension legacy table)
      POSTGRES_COLLECTION_NAME: ${POSTGRES_COLLECTION_NAME:-memories_ollama}
      # Neo4j connection
      NEO4J_URI: bolt://neo4j:${NEO4J_INTERNAL_BOLT_PORT:-7687}
      NEO4J_USERNAME: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      # API keys
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      MEM0_API_KEY: ${MEM0_API_KEY:?MEM0_API_KEY is required}
      # LLM/Embeddings (defaults should match installed host Ollama models)
      MEM0_LLM_PROVIDER: ${MEM0_LLM_PROVIDER:-ollama}
      MEM0_EMBEDDER_PROVIDER: ${MEM0_EMBEDDER_PROVIDER:-ollama}
      OLLAMA_URL: ${OLLAMA_URL:-http://host.docker.internal:11434}
      MEM0_LLM_MODEL: ${MEM0_LLM_MODEL:-mistral:7b-instruct-q4_K_M}
      MEM0_EMBEDDER_MODEL: ${MEM0_EMBEDDER_MODEL:-nomic-embed-text:latest}
      # Server config
      MEM0_BIND_ADDRESS: 0.0.0.0
      MEM0_PORT: ${MEM0_INTERNAL_PORT:-8888}
      HISTORY_DB_PATH: /app/data/history.db
      ENVIRONMENT: prd
      DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:?Must set DEPLOYMENT_ENV=prd in .env}
    command: ["/bin/bash", "/app/start_mem0_openai.sh"]
    volumes:
      - mem0_prd_data:/app/data
      - ./lib:/app/lib:ro
      - ./lib/mem0_gds_patch_v2_simple.py:/app/mem0_gds_patch_v2.py:ro
      - ./scripts/start_mem0_openai.sh:/app/start_mem0_openai.sh:ro
    ports:
      - "127.0.0.1:${MEM0_PORT:-8888}:8888"
    networks:
      - mem0_internal_prd
    labels:
      - "com.mem0-system.compose-file=docker-compose.prd.yml"
      - "com.mem0-system.environment=production"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8888/docs"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  neo4j:
    image: neo4j:5.13.0
    container_name: mem0_neo4j_prd
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NEO4J_PLUGINS: '["graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: gds.*
      NEO4J_dbms_security_procedures_allowlist: gds.*
      DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:?Must set DEPLOYMENT_ENV=prd in .env}
    ports:
      - "127.0.0.1:${NEO4J_HTTP_PORT:-7474}:7474"
      - "127.0.0.1:${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - mem0_prd_neo4j_data:/data
      - mem0_prd_neo4j_logs:/logs
      - mem0_prd_neo4j_import:/var/lib/neo4j/import
      - mem0_prd_neo4j_plugins:/plugins
    networks:
      - mem0_internal_prd
    labels:
      - "com.mem0-system.compose-file=docker-compose.prd.yml"
      - "com.mem0-system.environment=production"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    image: grafana/grafana:latest
    container_name: mem0_grafana_prd
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:?GRAFANA_PASSWORD is required}
      GF_SERVER_ROOT_URL: https://${TS_SERVE_GRAFANA_DOMAIN:-grafana-prd}.${TAILNET_NAME:-taile6d019.ts.net}
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
      GF_USERS_ALLOW_SIGN_UP: "false"
      DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:?Must set DEPLOYMENT_ENV=prd in .env}
    ports:
      - "127.0.0.1:${GRAFANA_PORT:-3000}:3000"
    volumes:
      - mem0_prd_grafana:/var/lib/grafana
    networks:
      - mem0_internal_prd
    labels:
      - "com.mem0-system.compose-file=docker-compose.prd.yml"
      - "com.mem0-system.environment=production"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  telegram_bot:
    build:
      context: ./telegram_bot
    container_name: mem0_telegram_bot_prd
    restart: unless-stopped
    depends_on:
      mem0:
        condition: service_healthy
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN is required}
      # Safety: always target the internal service name on the compose network
      MEM0_URL: http://mem0:8888
      MEM0_API_KEY: ${MEM0_API_KEY:?MEM0_API_KEY is required}
      DEFAULT_NAMESPACE: ${DEFAULT_NAMESPACE:-sap}
      NAMESPACES: ${NAMESPACES:-sap,personal,progressief,cv_automation,investments,intel_system,wingman,mem0}
      USER_PREFIX: ${USER_PREFIX:-mark_carey}
      MAX_RECALL_RESULTS: ${MAX_RECALL_RESULTS:-5}
      DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:?Must set DEPLOYMENT_ENV=prd in .env}
    networks:
      - mem0_internal_prd
    labels:
      - "com.mem0-system.compose-file=docker-compose.prd.yml"
      - "com.mem0-system.environment=production"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres_memory_exporter:
    build:
      context: ./monitoring
      dockerfile: Dockerfile.postgres_memory_exporter
    image: mem0-postgres-exporter:local
    container_name: mem0_postgres_exporter_prd
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user_prd}
      POSTGRES_DB: ${POSTGRES_DB:-mem0_prd}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      EXPORTER_PORT: 9094
      DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:?Must set DEPLOYMENT_ENV=prd in .env}
    ports:
      - "127.0.0.1:9094:9094"
    networks:
      - mem0_internal_prd
    labels:
      - "com.mem0-system.compose-file=docker-compose.prd.yml"
      - "com.mem0-system.environment=production"
      - "com.mem0-system.component=monitoring"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mem0_prd_postgres_data:
    external: true
    name: mem0_tailscale-data_prd
  mem0_prd_data:
    external: true
    name: mem0_tailscale_mem0_data
  mem0_prd_neo4j_data:
    external: true
    name: mem0-system_mem0_prd_neo4j_data
  mem0_prd_neo4j_logs:
    external: true
    name: mem0-system_mem0_prd_neo4j_logs
  mem0_prd_neo4j_import:
    external: true
    name: mem0-system_mem0_prd_neo4j_import
  mem0_prd_neo4j_plugins:
    external: true
    name: mem0-system_mem0_prd_neo4j_plugins
  mem0_prd_grafana:
    external: true
    name: mem0-system_mem0_prd_grafana

networks:
  mem0_internal_prd:
    driver: bridge
    name: mem0_internal_prd
    external: false