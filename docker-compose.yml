version: "3.9"

name: mem0_prd

services:
  postgres:
    image: ${POSTGRES_IMAGE:-pgvector/pgvector}:${POSTGRES_VERSION:-pg17}
    container_name: ${POSTGRES_CONTAINER_NAME:-mem0_postgres}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-mem0}
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - ${MEM0_DATA_ROOT:-/opt/mem0}/postgres:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_BIND_IP:-127.0.0.1}:${POSTGRES_PORT:-5433}:${POSTGRES_INTERNAL_PORT:-5432}"
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mem0_user}"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}

  mem0_prd:
    image: ${MEM0_IMAGE:-mem0-fixed}:${MEM0_VERSION:-local}
    container_name: ${MEM0_CONTAINER_NAME:-mem0_prd}
    restart: ${RESTART_POLICY:-unless-stopped}
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_INTERNAL_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-mem0}
      POSTGRES_USER: ${POSTGRES_USER:-mem0_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_COLLECTION_NAME: ${POSTGRES_COLLECTION_NAME:-memories}
      HISTORY_DB_PATH: ${HISTORY_DB_PATH:-/app/data/history.db}
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      MEM0_API_KEY: ${MEM0_API_KEY:?MEM0_API_KEY is required}
      MEM0_BIND_ADDRESS: ${MEM0_BIND_ADDRESS:-0.0.0.0}
      MEM0_PORT: ${MEM0_INTERNAL_PORT:-8888}
      # LLM Routing Configuration - Local-First Strategy
      # FIXED 2025-10-16: Default to containerized intel-llm-router (not host Ollama)
      LLM_ROUTING_ENABLED: ${LLM_ROUTING_ENABLED:-true}
      LLM_LOCAL_THRESHOLD: ${LLM_LOCAL_THRESHOLD:-95}  # Target 95% local routing
      OLLAMA_URL: ${OLLAMA_URL:-http://intel-llm-router:8000}
      # Mem0 LLM Provider Configuration
      MEM0_LLM_PROVIDER: ${MEM0_LLM_PROVIDER:-ollama}
      MEM0_LLM_MODEL: ${MEM0_LLM_MODEL:-mistral:7b}
      MEM0_EMBEDDER_PROVIDER: ${MEM0_EMBEDDER_PROVIDER:-ollama}
      MEM0_EMBEDDER_MODEL: ${MEM0_EMBEDDER_MODEL:-nomic-embed-text:latest}
      # Enable Neo4j with GDS Patch (Local deployment: 2025-10-21)
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USERNAME: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NEO4J_DATABASE: ${NEO4J_DATABASE:-neo4j}
    volumes:
      - ${MEM0_DATA_ROOT:-/opt/mem0}/data:/app/data
      - ./mem0_gds_patch_v2.py:/app/mem0_gds_patch_v2.py:ro
      - ./start_mem0_with_patch.sh:/app/start_mem0_with_patch.sh:ro
    command: ["/bin/bash", "/app/start_mem0_with_patch.sh"]
    ports:
      - "${MEM0_BIND_IP:-127.0.0.1}:${MEM0_PORT:-8888}:${MEM0_INTERNAL_PORT:-8888}"
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://${MEM0_BIND_ADDRESS:-0.0.0.0}:${MEM0_INTERNAL_PORT:-8888}${MEM0_HEALTH_PATH:-/docs}"]
      interval: ${MEM0_HEALTHCHECK_INTERVAL:-15s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}

  neo4j:
    image: ${NEO4J_IMAGE:-neo4j}:${NEO4J_VERSION:-5.13.0}
    container_name: ${NEO4J_CONTAINER_NAME:-mem0_neo4j}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-mem0_neo4j_pass}
      NEO4J_PLUGINS: '["graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: gds.*
      NEO4J_dbms_security_procedures_allowlist: gds.*
    ports:
      - "${NEO4J_BIND_IP:-127.0.0.1}:${NEO4J_HTTP_PORT:-7474}:${NEO4J_HTTP_INTERNAL_PORT:-7474}"
      - "${NEO4J_BIND_IP:-127.0.0.1}:${NEO4J_BOLT_PORT:-7687}:${NEO4J_BOLT_INTERNAL_PORT:-7687}"
    volumes:
      - ${MEM0_DATA_ROOT:-/opt/mem0}/neo4j:/data
      - ${MEM0_DATA_ROOT:-/opt/mem0}/neo4j/logs:/logs
      - ${MEM0_DATA_ROOT:-/opt/mem0}/neo4j/import:/var/lib/neo4j/import
      - ${MEM0_DATA_ROOT:-/opt/mem0}/neo4j/plugins:/plugins
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${NEO4J_HTTP_INTERNAL_PORT:-7474} || exit 1"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}

  grafana:
    image: ${GRAFANA_IMAGE:-grafana/grafana}:${GRAFANA_VERSION:-latest}
    container_name: ${GRAFANA_CONTAINER_NAME:-mem0_grafana}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    ports:
      - "${GRAFANA_BIND_IP:-127.0.0.1}:${GRAFANA_PORT:-3000}:${GRAFANA_INTERNAL_PORT:-3000}"
    volumes:
      - ${MEM0_DATA_ROOT:-/opt/mem0}/grafana:/var/lib/grafana
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}

  telegram_bot:
    build:
      context: ${TELEGRAM_BOT_BUILD_CONTEXT:-./telegram_bot}
    container_name: ${TELEGRAM_BOT_CONTAINER_NAME:-mem0_telegram_bot}
    restart: ${RESTART_POLICY:-unless-stopped}
    depends_on:
      mem0_prd:
        condition: service_healthy
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN is required}
      MEM0_URL: http://mem0_prd:8888
      MEM0_API_KEY: ${MEM0_API_KEY:?MEM0_API_KEY is required}
      DEFAULT_NAMESPACE: personal
      USER_PREFIX: mark_carey
      MAX_RECALL_RESULTS: "5"
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}
    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-3}

  prometheus:
    image: prom/prometheus:latest
    container_name: ${PROMETHEUS_CONTAINER_NAME:-mem0_prometheus}
    restart: ${RESTART_POLICY:-unless-stopped}
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ${MEM0_DATA_ROOT:-/opt/mem0}/prometheus:/prometheus
    ports:
      - "${PROMETHEUS_BIND_IP:-127.0.0.1}:${PROMETHEUS_PORT:-9091}:9090"
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  mem0_exporter:
    image: python:3.11-slim
    container_name: ${MEM0_EXPORTER_CONTAINER_NAME:-mem0_prometheus_exporter}
    restart: ${RESTART_POLICY:-unless-stopped}
    depends_on:
      mem0_prd:
        condition: service_healthy
    environment:
      MEM0_URL: ${MEM0_EXPORTER_URL:-http://mem0_prd:8888}
      MEM0_API_KEY: ${MEM0_API_KEY:-}
      PROMETHEUS_PORT: 9092
      SCRAPE_INTERVAL: ${MEM0_SCRAPE_INTERVAL:-15}
    volumes:
      - ../../scripts/mem0_prometheus_exporter.py:/app/exporter.py:ro
    working_dir: /app
    command: ["sh", "-c", "pip install prometheus-client requests && python exporter.py"]
    ports:
      - "${MEM0_EXPORTER_BIND_IP:-127.0.0.1}:${MEM0_METRICS_PORT:-9092}:9092"
    networks:
      - ${MEM0_NETWORK_NAME:-mem0_internal}
    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-3}

networks:
  mem0_internal:
    driver: ${NETWORK_DRIVER:-bridge}
    name: ${MEM0_NETWORK_NAME:-mem0_internal}
